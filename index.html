<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestaurantOS - Plateforme de Gestion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <style>
        .phase-progress { transition: width 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .task-card { transition: all 0.2s ease; }
        .modal-enter { animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Dark Mode Complet */
        .dark { background-color: #0f172a !important; color: #e2e8f0 !important; }
        .dark body { background-color: #0f172a !important; }
        .dark .bg-white { background-color: #1e293b !important; color: #e2e8f0 !important; }
        .dark .bg-gray-50 { background-color: #0f172a !important; }
        .dark .bg-gray-100 { background-color: #334155 !important; }
        .dark .text-gray-600 { color: #94a3b8 !important; }
        .dark .text-gray-700 { color: #cbd5e1 !important; }
        .dark .text-gray-900 { color: #f1f5f9 !important; }
        .dark .text-gray-500 { color: #64748b !important; }
        .dark .border { border-color: #334155 !important; }
        .dark .border-b { border-bottom-color: #334155 !important; }
        .dark .border-t { border-top-color: #334155 !important; }
        .dark .divide-y > * { border-color: #334155 !important; }
        .dark .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5) !important; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5) !important; }
        .dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5) !important; }
        .dark .hover\:bg-gray-50:hover { background-color: #334155 !important; }
        .dark .hover\:bg-gray-100:hover { background-color: #475569 !important; }
        .dark nav { background-color: #1e293b !important; }
        
        .dark input, .dark textarea, .dark select {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        .dark input:focus, .dark textarea:focus, .dark select:focus {
            background-color: #1e293b !important;
            border-color: #3b82f6 !important;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: #64748b !important;
        }
        .dark .task-card { background-color: #1e293b !important; }
        .dark .task-card:hover { background-color: #334155 !important; }
        
        .dark .bg-blue-50 { background-color: #1e3a5f !important; }
        .dark .bg-green-50 { background-color: #1e3a2f !important; }
        .dark .bg-yellow-50 { background-color: #3a351e !important; }
        .dark .bg-purple-50 { background-color: #2e1e3a !important; }
        .dark .bg-blue-100 { background-color: #1e40af !important; }
        .dark .bg-green-100 { background-color: #166534 !important; }
        .dark .bg-red-100 { background-color: #991b1b !important; }
        .dark .bg-yellow-100 { background-color: #854d0e !important; }
        
        .dark .text-blue-600 { color: #60a5fa !important; }
        .dark .text-green-600 { color: #4ade80 !important; }
        .dark .text-purple-600 { color: #c084fc !important; }
        .dark .text-red-600 { color: #f87171 !important; }
        .dark .text-orange-600 { color: #fb923c !important; }
        .dark .text-blue-800 { color: #93c5fd !important; }

        .firebase-status {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
        }
        .firebase-connected { background-color: #10b981; color: white; }
        .firebase-disconnected { background-color: #ef4444; color: white; }

        /* Editable fields */
        .editable-number { 
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .editable-number:hover { 
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .dark .editable-number:hover {
            background-color: #334155 !important;
            border-color: #3b82f6 !important;
        }
        .editable-number:focus {
            outline: none;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="firebaseStatus" class="firebase-status firebase-disconnected">üî¥ D√©connect√©</div>

    <nav class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <h1 class="text-xl font-bold text-blue-600">üçΩÔ∏è RestaurantOS</h1>
                    <div class="hidden md:flex space-x-4">
                        <button onclick="showPage('dashboard')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">Dashboard</button>
                        <button onclick="showPage('projects')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">Projets</button>
                        <button onclick="showPage('tasks')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">T√¢ches</button>
                        <button onclick="showPage('phases')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">Phases</button>
                        <button onclick="showPage('features')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">Features</button>
                        <button onclick="showPage('ai')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">IA Assistant</button>
                        <button onclick="showPage('analytics')" class="nav-btn px-3 py-2 rounded hover:bg-gray-100">Analytics</button>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleDarkMode()" class="p-2 hover:bg-gray-100 rounded">
                        <span id="darkModeIcon">üåô</span>
                    </button>
                    <button onclick="toggleNotifications()" class="relative p-2 hover:bg-gray-100 rounded">
                        üîî
                        <span id="notifBadge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    <span class="text-sm text-gray-600">üë§ <span id="userName">Stephen</span></span>
                </div>
            </div>
        </div>
    </nav>

    <div id="notificationsPanel" class="hidden fixed right-4 top-16 w-80 bg-white rounded-lg shadow-xl border z-50">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-semibold">Notifications</h3>
            <button onclick="clearAllNotifications()" class="text-xs text-red-600 hover:text-red-700">Tout effacer</button>
        </div>
        <div id="notificationsList" class="max-h-96 overflow-y-auto divide-y"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="page max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600">Restaurants sign√©s</div>
                <div class="flex items-center justify-center space-x-2 mt-2">
                    <button onclick="changeSignedCount(-1)" class="w-8 h-8 bg-red-500 text-white rounded hover:bg-red-600 text-lg font-bold">‚àí</button>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">
                            <span id="signedRestaurants">3</span>/<span id="signedGoal" contenteditable="true" class="editable-number inline-block px-2 rounded">5</span>
                        </div>
                    </div>
                    <button onclick="changeSignedCount(1)" class="w-8 h-8 bg-green-500 text-white rounded hover:bg-green-600 text-lg font-bold">+</button>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-center">Objectif mois</div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600">Revenu MRR</div>
                <div class="text-center mt-2">
                    <input id="mrr" type="number" value="1200" onchange="updateMRR(this.value)" class="text-2xl font-bold text-green-600 text-center w-24 border-0 editable-number rounded px-2">
                    <span class="text-2xl font-bold text-green-600">‚Ç¨</span>
                    <div class="text-xs text-gray-500 mt-1">
                        / <input id="mrrGoal" type="number" value="5000" class="w-16 text-xs border-0 editable-number rounded px-1" onchange="saveData()">‚Ç¨ objectif
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600">T√¢ches compl√©t√©es</div>
                <div class="text-2xl font-bold text-purple-600 text-center mt-2">
                    <span id="completedTasks">0</span>/<span id="totalTasks">0</span>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-center"><span id="completionPercent">0</span>%</div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600">T√¢ches en cours</div>
                <div class="text-2xl font-bold text-orange-600 text-center mt-2"><span id="ongoingTasks">0</span></div>
                <div class="text-xs text-gray-500 mt-1 text-center">√Ä suivre</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold">üöÄ Projets Actifs</h2>
            </div>
            <div id="activeProjects" class="divide-y"></div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold">‚úÖ T√¢ches Prioritaires</h2>
                </div>
                <div id="urgentTasks" class="p-4 space-y-3"></div>
            </div>

            <div class="bg-blue-50 rounded-lg shadow border-2 border-blue-200">
                <div class="p-4 border-b border-blue-200 bg-blue-100">
                    <h2 class="text-lg font-semibold text-blue-800">üí° IA Assistant</h2>
                </div>
                <div class="p-4">
                    <div class="bg-white rounded p-3 mb-3 text-sm">
                        <strong>Suggestion:</strong><br>
                        Commence par les t√¢ches prioritaires.
                    </div>
                    <button onclick="showPage('ai')" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        Discuter avec l'IA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROJECTS -->
    <div id="projects" class="page hidden max-w-7xl mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">üìÅ Projets</h2>
            <button onclick="openProjectModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Nouveau</button>
        </div>
        <div id="projectsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- TASKS -->
    <div id="tasks" class="page hidden max-w-7xl mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">üìã T√¢ches</h2>
            <button onclick="openTaskModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Nouvelle</button>
        </div>
        <div id="tasksBoard" class="grid md:grid-cols-4 gap-4">
            <div class="bg-gray-100 rounded-lg p-4">
                <h3 class="font-semibold mb-3">üìù √Ä faire (<span id="todoCount">0</span>)</h3>
                <div id="todoColumn" class="space-y-2"></div>
            </div>
            <div class="bg-blue-100 rounded-lg p-4">
                <h3 class="font-semibold mb-3">üîÑ En cours (<span id="doingCount">0</span>)</h3>
                <div id="doingColumn" class="space-y-2"></div>
            </div>
            <div class="bg-red-100 rounded-lg p-4">
                <h3 class="font-semibold mb-3">‚ö†Ô∏è Bloqu√©es (<span id="blockedCount">0</span>)</h3>
                <div id="blockedColumn" class="space-y-2"></div>
            </div>
            <div class="bg-green-100 rounded-lg p-4">
                <h3 class="font-semibold mb-3">‚úÖ Termin√©es (<span id="doneCount">0</span>)</h3>
                <div id="doneColumn" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- PHASES -->
    <div id="phases" class="page hidden max-w-7xl mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">üéØ Phases</h2>
            <button onclick="openPhaseModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Ajouter</button>
        </div>
        <div id="phasesList" class="space-y-6"></div>
    </div>

    <!-- FEATURES -->
    <div id="features" class="page hidden max-w-7xl mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">‚öôÔ∏è Features</h2>
            <button onclick="openFeatureModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Ajouter</button>
        </div>
        <div id="featuresList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- ANALYTICS -->
    <div id="analytics" class="page hidden max-w-7xl mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">üìà Analytics</h2>
            <button onclick="openAnalyticsModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‚öôÔ∏è Modifier</button>
        </div>
        
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-6">
                <div class="text-sm opacity-90 mb-2">Revenus annuels</div>
                <div class="text-3xl font-bold"><span id="analyticsYearRevenue">14400</span>‚Ç¨</div>
                <div class="text-sm mt-2 opacity-75">+<span id="analyticsYearGrowth">32</span>%</div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-6">
                <div class="text-sm opacity-90 mb-2">Temps gagn√©</div>
                <div class="text-3xl font-bold"><span id="analyticsTimeSaved">540</span>h/mois</div>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg shadow-lg p-6">
                <div class="text-sm opacity-90 mb-2">Taux conversion</div>
                <div class="text-3xl font-bold"><span id="analyticsConversionRate">30</span>%</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">üí∞ R√©partition Revenus</h3>
                <button onclick="openRevenueModal()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">‚úèÔ∏è</button>
            </div>
            <div id="revenueBreakdownList" class="space-y-3"></div>
        </div>
    </div>

    <!-- AI -->
    <div id="ai" class="page hidden max-w-4xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-t-lg">
                <h2 class="text-xl font-bold">ü§ñ Assistant IA</h2>
            </div>
            <div id="chatMessages" class="p-4 h-96 overflow-y-auto">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <strong>IA:</strong> Bonjour ! Comment puis-je t'aider ?
                </div>
            </div>
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input id="aiInput" type="text" placeholder="Pose ta question..." class="flex-1 border rounded px-3 py-2" onkeypress="if(event.key==='Enter') sendAIMessage()">
                    <button onclick="sendAIMessage()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="projectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Nouveau Restaurant</h3>
            <div class="space-y-3">
                <input id="newProjectName" type="text" placeholder="Nom *" class="w-full border rounded px-3 py-2">
                <input id="newProjectContact" type="email" placeholder="Email *" class="w-full border rounded px-3 py-2">
                <input id="newProjectPhone" type="tel" placeholder="T√©l√©phone" class="w-full border rounded px-3 py-2">
                <input id="newProjectRevenue" type="number" placeholder="Revenu (‚Ç¨)" class="w-full border rounded px-3 py-2">
            </div>
            <div class="flex space-x-2 mt-4">
                <button onclick="closeProjectModal()" class="flex-1 border rounded py-2">Annuler</button>
                <button onclick="saveProject()" class="flex-1 bg-blue-600 text-white rounded py-2">Cr√©er</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Nouvelle T√¢che</h3>
            <div class="space-y-3">
                <input id="newTaskTitle" type="text" placeholder="Titre *" class="w-full border rounded px-3 py-2">
                <select id="newTaskProject" class="w-full border rounded px-3 py-2">
                    <option value="">Projet *</option>
                </select>
                <select id="newTaskAssignee" class="w-full border rounded px-3 py-2">
                    <option value="Stephen">Stephen</option>
                    <option value="Eva">Eva</option>
                </select>
                <select id="newTaskPriority" class="w-full border rounded px-3 py-2">
                    <option value="low">Basse</option>
                    <option value="medium">Moyenne</option>
                    <option value="high">Haute</option>
                    <option value="urgent">Urgente</option>
                </select>
            </div>
            <div class="flex space-x-2 mt-4">
                <button onclick="closeTaskModal()" class="flex-1 border rounded py-2">Annuler</button>
                <button onclick="createTask()" class="flex-1 bg-blue-600 text-white rounded py-2">Cr√©er</button>
            </div>
        </div>
    </div>

    <div id="phaseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Nouvelle Phase</h3>
            <input id="newPhaseName" type="text" placeholder="Nom" class="w-full border rounded px-3 py-2 mb-3">
            <div class="flex space-x-2">
                <button onclick="closePhaseModal()" class="flex-1 border rounded py-2">Annuler</button>
                <button onclick="savePhase()" class="flex-1 bg-blue-600 text-white rounded py-2">Cr√©er</button>
            </div>
        </div>
    </div>

    <div id="featureModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Nouvelle Feature</h3>
            <input id="newFeatureName" type="text" placeholder="Nom" class="w-full border rounded px-3 py-2 mb-3">
            <div class="flex space-x-2">
                <button onclick="closeFeatureModal()" class="flex-1 border rounded py-2">Annuler</button>
                <button onclick="createFeature()" class="flex-1 bg-blue-600 text-white rounded py-2">Cr√©er</button>
            </div>
        </div>
    </div>

    <div id="analyticsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">M√©triques</h3>
            <div class="space-y-3">
                <input id="editYearRevenue" type="number" placeholder="Revenus annuels" class="w-full border rounded px-3 py-2">
                <input id="editYearGrowth" type="number" placeholder="Croissance %" class="w-full border rounded px-3 py-2">
            </div>
            <div class="flex space-x-2 mt-4">
                <button onclick="closeAnalyticsModal()" class="flex-1 border rounded py-2">Annuler</button>
                <button onclick="saveAnalytics()" class="flex-1 bg-blue-600 text-white rounded py-2">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="revenueModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">R√©partition Revenus</h3>
            <div id="revenueBreakdownInputs" class="space-y-2 mb-3"></div>
            <button onclick="addRevenueCategory()" class="w-full border-2 border-dashed rounded py-2 mb-3">+ Ajouter</button>
            <div class="flex space-x-2">
                <button onclick="closeRevenueModal()" class="flex-1 border rounded py-2">Annuler</button>
                <button onclick="saveRevenueBreakdown()" class="flex-1 bg-blue-600 text-white rounded py-2">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDOXDHOQj2cADZ9ai2uHzQ1lE8HsX3P3Hg",
            authDomain: "restaurantos-7bf0a.firebaseapp.com",
            databaseURL: "https://restaurantos-7bf0a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "restaurantos-7bf0a",
            storageBucket: "restaurantos-7bf0a.firebasestorage.app",
            messagingSenderId: "501432201588",
            appId: "1:501432201588:web:3720005ca099406dab3c21",
            measurementId: "G-N1KHN4JGEM"
        };

        let firebaseApp, database, analytics, useFirebase = false;

        function initFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                analytics = firebase.analytics();
                useFirebase = true;
                
                database.ref('restaurantOS').on('value', (snapshot) => {
                    const remoteData = snapshot.val();
                    if (remoteData) {
                        data = remoteData;
                        refreshAllUI();
                        updateFirebaseStatus(true);
                    }
                });
                
                database.ref('.info/connected').on('value', (snapshot) => {
                    updateFirebaseStatus(snapshot.val());
                });
                
                console.log('‚úÖ Firebase connect√©');
            } catch (error) {
                console.error('‚ùå Firebase:', error);
                useFirebase = false;
                document.getElementById('firebaseStatus').style.display = 'none';
            }
        }

        function updateFirebaseStatus(connected) {
            const el = document.getElementById('firebaseStatus');
            el.className = 'firebase-status ' + (connected ? 'firebase-connected' : 'firebase-disconnected');
            el.textContent = connected ? 'üü¢ Synchronis√©' : 'üî¥ D√©connect√©';
        }

        // DATA
        let data = {
            settings: { signedGoal: 5, signedCount: 3, mrrGoal: 5000, currentMRR: 1200 },
            projects: [
                {id: 1, name: "La Bella Vita", contact: "bella@test.fr", phone: "06123", status: "active", revenue: 400, phase: 2, progress: 65},
                {id: 2, name: "Sushi Zen", contact: "sushi@test.fr", phone: "06456", status: "demo", revenue: 350, phase: 1, progress: 20}
            ],
            tasks: [
                {id: 1, projectId: 1, title: "Prompt IA", assignee: "Stephen", status: "doing", priority: "high", goal: "Satisfaction"},
                {id: 2, projectId: 2, title: "D√©ployer site", assignee: "Eva", status: "todo", priority: "urgent", goal: "D√©mo"}
            ],
            features: [
                {id: 1, name: "R√©servations", icon: "üìÖ", desc: "Automatis√©", type: "included", price: 0},
                {id: 2, name: "Menus digitaux", icon: "üçΩÔ∏è", desc: "QR Code", type: "included", price: 0}
            ],
            phases: [
                {id: 1, name: "D√©mo", duration: "7-10j", color: "blue", codeTasks: ["Structure"], strategyTasks: ["Prompts"]},
                {id: 2, name: "Int√©gration", duration: "5-7j", color: "green", codeTasks: ["API"], strategyTasks: ["Tests"]}
            ],
            analytics: { yearRevenue: 14400, yearGrowth: 32, timeSaved: 540, conversionRate: 30, revenueBreakdown: [{name: "Abonnements", amount: 1200}] },
            notifications: [],
            darkMode: true
        };

        // SAVE/LOAD
        function saveData() {
            if (useFirebase && database) {
                database.ref('restaurantOS').set(data).catch(e => console.error(e));
            } else {
                try { localStorage.setItem('restaurantOS_data', JSON.stringify(data)); } catch(e) {}
            }
        }

        function loadData() {
            if (useFirebase) return;
            try {
                const saved = localStorage.getItem('restaurantOS_data');
                if (saved) data = {...data, ...JSON.parse(saved)};
            } catch(e) {}
            refreshAllUI();
        }

        function refreshAllUI() {
            loadDashboard();
            loadProjects();
            loadTasks();
            loadFeatures();
            loadPhases();
            loadAnalytics();
            loadNotifications();
            
            document.getElementById('mrr').value = data.settings.currentMRR;
            document.getElementById('mrrGoal').value = data.settings.mrrGoal;
            document.getElementById('signedGoal').textContent = data.settings.signedGoal;
            document.getElementById('signedRestaurants').textContent = data.settings.signedCount;
        }

        // DARK MODE
        function toggleDarkMode() {
            data.darkMode = !data.darkMode;
            document.body.classList.toggle('dark', data.darkMode);
            document.getElementById('darkModeIcon').textContent = data.darkMode ? '‚òÄÔ∏è' : 'üåô';
            saveData();
        }

        // EDITABLE
        function changeSignedCount(delta) {
            data.settings.signedCount = Math.max(0, (data.settings.signedCount || 0) + delta);
            document.getElementById('signedRestaurants').textContent = data.settings.signedCount;
            saveData();
        }

        function updateMRR(value) {
            data.settings.currentMRR = parseInt(value) || 0;
            saveData();
        }

        // Rendre les champs √©ditables
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('input', (e) => {
                if (e.target.id === 'signedGoal') {
                    data.settings.signedGoal = parseInt(e.target.textContent) || 5;
                    saveData();
                } else if (e.target.id === 'mrrGoal') {
                    data.settings.mrrGoal = parseInt(e.target.value) || 5000;
                    saveData();
                }
            });
        });

        // NAVIGATION
        function showPage(name) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(name).classList.remove('hidden');
            if (name === 'projects') loadProjects();
            if (name === 'tasks') loadTasks();
            if (name === 'features') loadFeatures();
            if (name === 'phases') loadPhases();
            if (name === 'analytics') loadAnalytics();
        }

        // DASHBOARD
        function loadDashboard() {
            const activeProjects = document.getElementById('activeProjects');
            activeProjects.innerHTML = data.projects.filter(p => p.status === 'active' || p.status === 'demo').map(p => `
                <div class="p-4 hover:bg-gray-50 cursor-pointer">
                    <div class="flex justify-between mb-2">
                        <h3 class="font-semibold">${p.name}</h3>
                        <span class="text-xs px-2 py-1 rounded ${p.status === 'active' ? 'bg-green-200' : 'bg-yellow-200'}">${p.status}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width:${p.progress}%"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-2">üí∞ ${p.revenue}‚Ç¨/mois</div>
                </div>
            `).join('');

            const urgentTasks = document.getElementById('urgentTasks');
            const urgent = data.tasks.filter(t => (t.priority === 'urgent' || t.priority === 'high') && t.status !== 'done').slice(0, 5);
            urgentTasks.innerHTML = urgent.length ? urgent.map(t => {
                const project = data.projects.find(p => p.id === t.projectId);
                return `
                    <div class="border-l-4 ${t.priority === 'urgent' ? 'border-red-500' : 'border-orange-400'} pl-3 py-2 bg-gray-50 rounded">
                        <div class="font-medium text-sm">${t.title}</div>
                        <div class="text-xs text-gray-600">${project?.name || 'N/A'} ‚Ä¢ ${t.assignee}</div>
                    </div>
                `;
            }).join('') : '<div class="text-gray-500 text-sm">Aucune t√¢che prioritaire</div>';

            document.getElementById('signedRestaurants').textContent = data.settings.signedCount;
            document.getElementById('signedGoal').textContent = data.settings.signedGoal;
            
            const completed = data.tasks.filter(t => t.status === 'done').length;
            const total = data.tasks.length;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completionPercent').textContent = total ? Math.round((completed/total)*100) : 0;
            document.getElementById('ongoingTasks').textContent = data.tasks.filter(t => t.status === 'doing').length;
        }

        // PROJECTS
        function loadProjects() {
            const list = document.getElementById('projectsList');
            list.innerHTML = data.projects.map(p => `
                <div class="bg-white rounded-lg shadow p-4 hover:shadow-lg transition">
                    <h3 class="font-bold text-lg mb-2">${p.name}</h3>
                    <div class="text-sm text-gray-600 space-y-1 mb-3">
                        <div>üìß ${p.contact}</div>
                        <div>üì± ${p.phone}</div>
                    </div>
                    <div class="border-t pt-3">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Phase ${p.phase}/4</span>
                            <span class="font-semibold">${p.progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width:${p.progress}%"></div>
                        </div>
                        <div class="mt-2 text-right">
                            <span class="text-green-600 font-bold">${p.revenue}‚Ç¨/mois</span>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('newTaskProject').innerHTML = '<option value="">Projet</option>' + 
                data.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function openProjectModal() { document.getElementById('projectModal').classList.remove('hidden'); }
        function closeProjectModal() { document.getElementById('projectModal').classList.add('hidden'); }

        function saveProject() {
            const name = document.getElementById('newProjectName').value;
            const contact = document.getElementById('newProjectContact').value;
            const phone = document.getElementById('newProjectPhone').value;
            const revenue = parseInt(document.getElementById('newProjectRevenue').value) || 0;

            if (!name || !contact) return alert('‚ö†Ô∏è Nom et email obligatoires');

            const newId = Math.max(...data.projects.map(p => p.id), 0) + 1;
            data.projects.push({id: newId, name, contact, phone, revenue, status: 'prospect', phase: 1, progress: 0});

            closeProjectModal();
            loadProjects();
            loadDashboard();
            saveData();
            addNotification('success', `Restaurant "${name}" cr√©√©`, 'Maintenant');
            
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectContact').value = '';
            document.getElementById('newProjectPhone').value = '';
            document.getElementById('newProjectRevenue').value = '';
        }

        // TASKS
        function loadTasks() {
            const columns = {todo: [], doing: [], blocked: [], done: []};
            data.tasks.forEach(t => columns[t.status].push(t));

            Object.keys(columns).forEach(status => {
                const col = document.getElementById(status + 'Column');
                const count = document.getElementById(status + 'Count');
                if (count) count.textContent = columns[status].length;
                
                col.innerHTML = columns[status].map(t => {
                    const project = data.projects.find(p => p.id === t.projectId);
                    return `
                        <div class="bg-white p-3 rounded shadow-sm border-l-4 ${t.priority === 'urgent' ? 'border-red-500' : t.priority === 'high' ? 'border-orange-400' : 'border-blue-400'} cursor-pointer hover:shadow">
                            <div class="font-semibold text-sm mb-1">${t.title}</div>
                            <div class="text-xs text-gray-600 mb-2">${project?.name || 'N/A'}</div>
                            <div class="text-xs"><span class="px-2 py-0.5 bg-gray-100 rounded">${t.assignee}</span></div>
                        </div>
                    `;
                }).join('');
            });
        }

        function openTaskModal() { document.getElementById('taskModal').classList.remove('hidden'); }
        function closeTaskModal() { document.getElementById('taskModal').classList.add('hidden'); }

        function createTask() {
            const title = document.getElementById('newTaskTitle').value;
            const projectId = parseInt(document.getElementById('newTaskProject').value);
            const assignee = document.getElementById('newTaskAssignee').value;
            const priority = document.getElementById('newTaskPriority').value;

            if (!title || !projectId) return alert('‚ö†Ô∏è Titre et projet obligatoires');

            const newId = Math.max(...data.tasks.map(t => t.id), 0) + 1;
            data.tasks.push({id: newId, projectId, title, assignee, priority, status: 'todo', goal: 'Objectif'});

            closeTaskModal();
            loadTasks();
            loadDashboard();
            saveData();
            addNotification('success', `T√¢che "${title}" cr√©√©e`, 'Maintenant');
            
            document.getElementById('newTaskTitle').value = '';
        }

        // FEATURES
        function loadFeatures() {
            const list = document.getElementById('featuresList');
            if (!list) return;
            list.innerHTML = data.features.map(f => `
                <div class="bg-white rounded-lg shadow p-4 border-l-4 ${f.type === 'included' ? 'border-green-500' : 'border-yellow-500'}">
                    <h3 class="font-bold text-lg">${f.icon} ${f.name}</h3>
                    <p class="text-sm text-gray-600 mb-3">${f.desc}</p>
                    <span class="text-xs px-2 py-1 rounded ${f.type === 'included' ? 'bg-green-100' : 'bg-yellow-100'}">
                        ${f.type === 'included' ? 'Inclus' : `+${f.price}‚Ç¨/mois`}
                    </span>
                </div>
            `).join('');
        }

        function openFeatureModal() { document.getElementById('featureModal').classList.remove('hidden'); }
        function closeFeatureModal() { document.getElementById('featureModal').classList.add('hidden'); }

        function createFeature() {
            const name = document.getElementById('newFeatureName').value;
            if (!name) return alert('‚ö†Ô∏è Nom obligatoire');

            const newId = Math.max(...data.features.map(f => f.id), 0) + 1;
            data.features.push({id: newId, name, icon: '‚öôÔ∏è', desc: 'Nouvelle feature', type: 'included', price: 0});

            closeFeatureModal();
            loadFeatures();
            saveData();
            addNotification('success', `Feature "${name}" cr√©√©e`, 'Maintenant');
            document.getElementById('newFeatureName').value = '';
        }

        // PHASES
        function loadPhases() {
            const list = document.getElementById('phasesList');
            if (!list) return;
            list.innerHTML = data.phases.map(p => `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b bg-${p.color}-50">
                        <h3 class="text-lg font-bold">${p.name}</h3>
                        <span class="text-sm text-gray-600">${p.duration}</span>
                    </div>
                    <div class="p-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">üíª CODE</h4>
                                <ul class="text-sm space-y-1">
                                    ${p.codeTasks.map(t => `<li>‚Ä¢ ${t}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">üß† STRAT√âGIE</h4>
                                <ul class="text-sm space-y-1">
                                    ${p.strategyTasks.map(t => `<li>‚Ä¢ ${t}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openPhaseModal() { document.getElementById('phaseModal').classList.remove('hidden'); }
        function closePhaseModal() { document.getElementById('phaseModal').classList.add('hidden'); }

        function savePhase() {
            const name = document.getElementById('newPhaseName').value;
            if (!name) return alert('‚ö†Ô∏è Nom obligatoire');

            const newId = Math.max(...data.phases.map(p => p.id), 0) + 1;
            data.phases.push({id: newId, name, duration: '5j', color: 'blue', codeTasks: ['T√¢che'], strategyTasks: ['T√¢che']});

            closePhaseModal();
            loadPhases();
            saveData();
            addNotification('success', `Phase "${name}" cr√©√©e`, 'Maintenant');
            document.getElementById('newPhaseName').value = '';
        }

        // ANALYTICS
        function loadAnalytics() {
            document.getElementById('analyticsYearRevenue').textContent = data.analytics.yearRevenue;
            document.getElementById('analyticsYearGrowth').textContent = data.analytics.yearGrowth;
            document.getElementById('analyticsTimeSaved').textContent = data.analytics.timeSaved;
            document.getElementById('analyticsConversionRate').textContent = data.analytics.conversionRate;

            const list = document.getElementById('revenueBreakdownList');
            if (!list) return;
            list.innerHTML = data.analytics.revenueBreakdown.map((item, i) => `
                <div class="flex justify-between items-center p-3 border rounded">
                    <div class="font-semibold">${item.name}</div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-green-600">${item.amount}‚Ç¨</span>
                        <button onclick="deleteRevenueCategory(${i})" class="text-red-500">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openAnalyticsModal() {
            document.getElementById('editYearRevenue').value = data.analytics.yearRevenue;
            document.getElementById('editYearGrowth').value = data.analytics.yearGrowth;
            document.getElementById('analyticsModal').classList.remove('hidden');
        }
        function closeAnalyticsModal() { document.getElementById('analyticsModal').classList.add('hidden'); }

        function saveAnalytics() {
            data.analytics.yearRevenue = parseInt(document.getElementById('editYearRevenue').value) || 0;
            data.analytics.yearGrowth = parseInt(document.getElementById('editYearGrowth').value) || 0;
            closeAnalyticsModal();
            loadAnalytics();
            saveData();
            addNotification('success', 'M√©triques mises √† jour', 'Maintenant');
        }

        function openRevenueModal() {
            const container = document.getElementById('revenueBreakdownInputs');
            container.innerHTML = data.analytics.revenueBreakdown.map((item, i) => `
                <div class="flex space-x-2">
                    <input type="text" value="${item.name}" class="flex-1 border rounded px-3 py-2 revenue-name">
                    <input type="number" value="${item.amount}" class="w-32 border rounded px-3 py-2 revenue-amount">
                </div>
            `).join('');
            document.getElementById('revenueModal').classList.remove('hidden');
        }
        function closeRevenueModal() { document.getElementById('revenueModal').classList.add('hidden'); }

        function addRevenueCategory() {
            const container = document.getElementById('revenueBreakdownInputs');
            const div = document.createElement('div');
            div.className = 'flex space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="Nom" class="flex-1 border rounded px-3 py-2 revenue-name">
                <input type="number" placeholder="Montant" class="w-32 border rounded px-3 py-2 revenue-amount">
            `;
            container.appendChild(div);
        }

        function saveRevenueBreakdown() {
            const names = document.querySelectorAll('.revenue-name');
            const amounts = document.querySelectorAll('.revenue-amount');
            
            data.analytics.revenueBreakdown = Array.from(names).map((n, i) => ({
                name: n.value || 'Sans nom',
                amount: parseInt(amounts[i].value) || 0
            })).filter(item => item.amount > 0);
            
            closeRevenueModal();
            loadAnalytics();
            saveData();
            addNotification('success', 'R√©partition mise √† jour', 'Maintenant');
        }

        function deleteRevenueCategory(index) {
            if (confirm('Supprimer ?')) {
                data.analytics.revenueBreakdown.splice(index, 1);
                loadAnalytics();
                saveData();
            }
        }

        // AI
        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            const chat = document.getElementById('chatMessages');
            chat.innerHTML += `<div class="bg-gray-100 p-3 rounded-lg text-right mt-3"><strong>Vous:</strong> ${msg}</div>`;
            input.value = '';
            
            setTimeout(() => {
                chat.innerHTML += `<div class="bg-blue-50 p-3 rounded-lg mt-3"><strong>IA:</strong> Message re√ßu !</div>`;
                chat.scrollTop = chat.scrollHeight;
            }, 500);
        }

        // NOTIFICATIONS
        function loadNotifications() {
            const list = document.getElementById('notificationsList');
            if (!data.notifications.length) {
                list.innerHTML = '<div class="p-3 text-center text-gray-500 text-sm">Aucune notification</div>';
                document.getElementById('notifBadge').classList.add('hidden');
                return;
            }
            
            list.innerHTML = data.notifications.map(n => `
                <div class="p-3 hover:bg-gray-50 flex justify-between">
                    <div class="flex-1">
                        <div class="text-sm">${n.message}</div>
                        <div class="text-xs text-gray-500">${n.time}</div>
                    </div>
                    <button onclick="deleteNotification(${n.id})" class="text-red-500 ml-2">√ó</button>
                </div>
            `).join('');
            
            document.getElementById('notifBadge').classList.remove('hidden');
            document.getElementById('notifBadge').textContent = data.notifications.length;
        }

        function toggleNotifications() {
            document.getElementById('notificationsPanel').classList.toggle('hidden');
        }

        function clearAllNotifications() {
            if (confirm('Effacer toutes les notifications ?')) {
                data.notifications = [];
                loadNotifications();
                saveData();
            }
        }

        function deleteNotification(id) {
            data.notifications = data.notifications.filter(n => n.id !== id);
            loadNotifications();
            saveData();
        }

        function addNotification(type, message, time) {
            const newId = Math.max(...data.notifications.map(n => n.id || 0), 0) + 1;
            data.notifications.unshift({id: newId, type, message, time});
            if (data.notifications.length > 10) data.notifications.pop();
            loadNotifications();
            saveData();
        }

        // AUTO-SAVE
        setInterval(() => { if (!useFirebase) saveData(); }, 5000);

        // CLICK OUTSIDE
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notificationsPanel');
            const btn = e.target.closest('button[onclick="toggleNotifications()"]');
            if (!panel.contains(e.target) && !btn && !panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
            }
        });

        // INIT
        window.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.body.classList.add('dark');
            document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            setTimeout(() => loadData(), 500);
        });
    </script>
</body>
</html>
